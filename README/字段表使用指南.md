# å­—æ®µè¡¨ä½¿ç”¨æŒ‡å—

## ğŸ“‹ æ¦‚è¿°

å­—æ®µè¡¨ï¼ˆsys_field_metadata å’Œ sys_table_metadataï¼‰æ˜¯ç”¨äºç®¡ç†ç³»ç»Ÿå…ƒæ•°æ®çš„ä¸¤ä¸ªæ ¸å¿ƒè¡¨ï¼Œå®ƒä»¬æä¾›äº†æ•°æ®åº“ç»“æ„çš„åŠ¨æ€ç®¡ç†èƒ½åŠ›ã€‚åœ¨æ–°çš„æ–‡æ¡£ç³»ç»Ÿå°è£…ä¸­ï¼Œè¿™äº›å…ƒæ•°æ®å¯ä»¥ç”¨äºè‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£ã€åŠ¨æ€è¡¨å•å’Œæ•°æ®éªŒè¯ã€‚

## ğŸ—ƒï¸ è¡¨ç»“æ„è¯´æ˜

### 1. sys_table_metadataï¼ˆè¡¨å…ƒæ•°æ®è¡¨ï¼‰
ç”¨äºç®¡ç†ç³»ç»Ÿä¸­æ‰€æœ‰è¡¨çš„åŸºæœ¬ä¿¡æ¯ã€‚

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| table_id | VARCHAR(32) | è¡¨å”¯ä¸€æ ‡è¯† |
| table_name | VARCHAR(64) | è¡¨å |
| table_label | VARCHAR(100) | è¡¨æ˜¾ç¤ºæ ‡ç­¾ï¼ˆä¸­æ–‡ï¼‰ |
| table_description | TEXT | è¡¨è¯¦ç»†æè¿° |
| module_name | VARCHAR(50) | æ‰€å±æ¨¡å—åç§° |
| is_system | TINYINT | æ˜¯å¦ç³»ç»Ÿè¡¨ï¼š0-å¦ï¼Œ1-æ˜¯ |
| table_type | VARCHAR(20) | è¡¨ç±»å‹ï¼šbusiness/system/log/config |
| create_time | DATETIME | åˆ›å»ºæ—¶é—´ |
| update_time | DATETIME | æ›´æ–°æ—¶é—´ |

### 2. sys_field_metadataï¼ˆå­—æ®µå…ƒæ•°æ®è¡¨ï¼‰
ç”¨äºç®¡ç†æ‰€æœ‰è¡¨å­—æ®µçš„è¯¦ç»†ä¿¡æ¯ã€‚

| å­—æ®µå | ç±»å‹ | è¯´æ˜ |
|--------|------|------|
| field_id | VARCHAR(32) | å­—æ®µå”¯ä¸€æ ‡è¯† |
| table_name | VARCHAR(64) | æ‰€å±è¡¨å |
| field_name | VARCHAR(64) | å­—æ®µå |
| field_type | VARCHAR(32) | å­—æ®µç±»å‹ï¼šstring/int/decimal/datetime/text |
| field_length | INT | å­—æ®µé•¿åº¦ |
| field_label | VARCHAR(100) | å­—æ®µæ˜¾ç¤ºæ ‡ç­¾ï¼ˆä¸­æ–‡ï¼‰ |
| field_description | TEXT | å­—æ®µè¯¦ç»†æè¿° |
| is_required | TINYINT | æ˜¯å¦å¿…å¡«ï¼š0-å¦ï¼Œ1-æ˜¯ |
| is_searchable | TINYINT | æ˜¯å¦å¯æœç´¢ï¼š0-å¦ï¼Œ1-æ˜¯ |
| is_display | TINYINT | æ˜¯å¦æ˜¾ç¤ºï¼š0-å¦ï¼Œ1-æ˜¯ |
| display_order | INT | æ˜¾ç¤ºé¡ºåº |
| default_value | TEXT | é»˜è®¤å€¼ |
| validation_rule | TEXT | éªŒè¯è§„åˆ™ï¼ˆJSONæ ¼å¼ï¼‰ |
| input_type | VARCHAR(20) | è¾“å…¥ç±»å‹ï¼štext/select/textarea/date |
| select_options | TEXT | é€‰æ‹©é¡¹ï¼ˆJSONæ ¼å¼ï¼‰ |
| is_primary_key | TINYINT | æ˜¯å¦ä¸»é”®ï¼š0-å¦ï¼Œ1-æ˜¯ |
| is_foreign_key | TINYINT | æ˜¯å¦å¤–é”®ï¼š0-å¦ï¼Œ1-æ˜¯ |
| foreign_table | VARCHAR(64) | å¤–é”®å…³è”è¡¨ |
| foreign_field | VARCHAR(64) | å¤–é”®å…³è”å­—æ®µ |
| create_time | DATETIME | åˆ›å»ºæ—¶é—´ |
| update_time | DATETIME | æ›´æ–°æ—¶é—´ |

## ğŸš€ ä½¿ç”¨åœºæ™¯

### 1. åŠ¨æ€è¡¨å•ç”Ÿæˆ
æ ¹æ®å­—æ®µå…ƒæ•°æ®è‡ªåŠ¨ç”Ÿæˆå‰ç«¯è¡¨å•ï¼š

```sql
-- è·å–ç”¨æˆ·è¡¨çš„æ‰€æœ‰æ˜¾ç¤ºå­—æ®µ
SELECT field_name, field_label, field_type, is_required, input_type, default_value
FROM sys_field_metadata 
WHERE table_name = 'sys_user' AND is_display = 1 
ORDER BY display_order;
```

### 2. æ•°æ®éªŒè¯
ä½¿ç”¨validation_ruleå­—æ®µè¿›è¡Œæ•°æ®éªŒè¯ï¼š

```json
{
  "min_length": 6,
  "max_length": 20,
  "pattern": "^[a-zA-Z0-9_]+$",
  "custom_rules": ["no_spaces", "unique_username"]
}
```

### 3. æœç´¢åŠŸèƒ½é…ç½®
æ ¹æ®is_searchableå­—æ®µåŠ¨æ€é…ç½®æœç´¢ï¼š

```sql
-- è·å–æ‰€æœ‰å¯æœç´¢çš„å­—æ®µ
SELECT table_name, field_name, field_label, field_type
FROM sys_field_metadata 
WHERE is_searchable = 1;
```

### 4. APIæ–‡æ¡£ç”Ÿæˆ
è‡ªåŠ¨ç”ŸæˆAPIæ–‡æ¡£ï¼š

```sql
-- è·å–è¡¨ç»“æ„å’Œå­—æ®µè¯´æ˜
SELECT 
    t.table_name,
    t.table_label,
    t.table_description,
    f.field_name,
    f.field_label,
    f.field_description,
    f.is_required,
    f.field_type
FROM sys_table_metadata t
JOIN sys_field_metadata f ON t.table_name = f.table_name
WHERE t.table_name = 'doc_document'
ORDER BY f.display_order;
```

## ğŸ’» ä¸æ–°ç³»ç»Ÿé›†æˆ

### 1. åœ¨DocumentSystemä¸­ä½¿ç”¨å…ƒæ•°æ®

```python
from document_system import create_document_system
import json

def get_table_metadata(system, table_name):
    """è·å–è¡¨çš„å…ƒæ•°æ®ä¿¡æ¯"""
    query = """
    SELECT 
        tm.table_name,
        tm.table_label,
        tm.table_description,
        fm.field_name,
        fm.field_label,
        fm.field_type,
        fm.is_required,
        fm.is_display,
        fm.input_type,
        fm.default_value,
        fm.validation_rule,
        fm.display_order
    FROM sys_table_metadata tm
    JOIN sys_field_metadata fm ON tm.table_name = fm.table_name
    WHERE tm.table_name = %s AND fm.is_display = 1
    ORDER BY fm.display_order
    """
    
    try:
        with system.db.get_connection() as conn:
            with conn.cursor(dictionary=True) as cursor:
                cursor.execute(query, (table_name,))
                results = cursor.fetchall()
                
                if results:
                    # æ„å»ºå…ƒæ•°æ®å­—å…¸
                    table_info = {
                        'table_name': results[0]['table_name'],
                        'table_label': results[0]['table_label'],
                        'table_description': results[0]['table_description'],
                        'fields': []
                    }
                    
                    for row in results:
                        field_info = {
                            'name': row['field_name'],
                            'label': row['field_label'],
                            'type': row['field_type'],
                            'required': bool(row['is_required']),
                            'input_type': row['input_type'],
                            'default_value': row['default_value']
                        }
                        
                        # è§£æéªŒè¯è§„åˆ™
                        if row['validation_rule']:
                            try:
                                field_info['validation'] = json.loads(row['validation_rule'])
                            except json.JSONDecodeError:
                                field_info['validation'] = {}
                        
                        table_info['fields'].append(field_info)
                    
                    return table_info
                else:
                    return None
    except Exception as e:
        print(f"è·å–è¡¨å…ƒæ•°æ®å¤±è´¥: {e}")
        return None

# ä½¿ç”¨ç¤ºä¾‹
system = create_document_system()
try:
    user_metadata = get_table_metadata(system, 'sys_user')
    if user_metadata:
        print(f"è¡¨å: {user_metadata['table_label']}")
        print("å­—æ®µåˆ—è¡¨:")
        for field in user_metadata['fields']:
            print(f"- {field['label']}: {field['name']} ({field['type']})")
finally:
    system.close()
```

### 2. åŠ¨æ€è¡¨å•é…ç½®ç”Ÿæˆ
```python
def generate_form_config(system, table_name):
    """ç”Ÿæˆè¡¨å•é…ç½®"""
    metadata = get_table_metadata(system, table_name)
    
    if not metadata:
        return None
    
    form_config = {
        'table_name': table_name,
        'table_label': metadata['table_label'],
        'table_description': metadata['table_description'],
        'fields': []
    }
    
    for field in metadata['fields']:
        field_config = {
            'name': field['name'],
            'label': field['label'],
            'type': field['input_type'],
            'required': field['required'],
            'placeholder': metadata['table_description']
        }
        
        # æ·»åŠ é€‰æ‹©é¡¹
        if field['input_type'] == 'select' and field.get('select_options'):
            try:
                field_config['options'] = json.loads(field['select_options'])
            except json.JSONDecodeError:
                pass
        
        # æ·»åŠ é»˜è®¤å€¼
        if field['default_value']:
            field_config['default'] = field['default_value']
        
        # æ·»åŠ éªŒè¯è§„åˆ™
        if field.get('validation'):
            field_config['validation'] = field['validation']
        
        form_config['fields'].append(field_config)
    
    return form_config

# ç”Ÿæˆç”¨æˆ·è¡¨å•é…ç½®
def demo_form_config():
    system = create_document_system()
    try:
        user_form = generate_form_config(system, 'sys_user')
        if user_form:
            print(json.dumps(user_form, ensure_ascii=False, indent=2))
    finally:
        system.close()
```

### 3. APIæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆ
```python
def generate_api_docs(system, table_name):
    """ç”ŸæˆAPIæ–‡æ¡£"""
    metadata = get_table_metadata(system, table_name)
    
    if not metadata:
        return None
    
    docs = {
        'table': table_name,
        'description': metadata['table_description'],
        'endpoints': {
            'create': {
                'method': 'POST',
                'path': f'/api/{table_name}',
                'description': f'åˆ›å»º{metadata["table_label"]}',
                'parameters': []
            },
            'read': {
                'method': 'GET',
                'path': f'/api/{table_name}/{{id}}',
                'description': f'è·å–{metadata["table_label"]}',
                'parameters': []
            },
            'update': {
                'method': 'PUT',
                'path': f'/api/{table_name}/{{id}}',
                'description': f'æ›´æ–°{metadata["table_label"]}',
                'parameters': []
            },
            'delete': {
                'method': 'DELETE',
                'path': f'/api/{table_name}/{{id}}',
                'description': f'åˆ é™¤{metadata["table_label"]}',
                'parameters': []
            }
        }
    }
    
    # æ·»åŠ å­—æ®µå‚æ•°
    for field in metadata['fields']:
        param = {
            'name': field['name'],
            'label': field['label'],
            'type': field['type'],
            'required': field['required'],
            'description': field.get('validation', {}).get('description', '')
        }
        
        if field['default_value']:
            param['default'] = field['default_value']
        
        # CREATEå’ŒUPDATEéœ€è¦æ‰€æœ‰å­—æ®µ
        docs['endpoints']['create']['parameters'].append(param.copy())
        docs['endpoints']['update']['parameters'].append(param.copy())
        
        # åªæœ‰éä¸»é”®å­—æ®µåœ¨CREATEä¸­æ˜¯å¿…éœ€çš„
        if field['name'].endswith('_id'):  # å‡è®¾ä¸»é”®ä»¥_idç»“å°¾
            docs['endpoints']['create']['parameters'][-1]['required'] = False
    
    return docs

# ç”ŸæˆAPIæ–‡æ¡£ç¤ºä¾‹
def demo_api_docs():
    system = create_document_system()
    try:
        api_docs = generate_api_docs(system, 'sys_user')
        if api_docs:
            print(json.dumps(api_docs, ensure_ascii=False, indent=2))
    finally:
        system.close()
```

## ğŸ“Š å¸¸ç”¨æŸ¥è¯¢ç¤ºä¾‹

### 1. è·å–è¡¨çš„å®Œæ•´ç»“æ„
```sql
-- è·å–ç”¨æˆ·è¡¨çš„å®Œæ•´ç»“æ„
SELECT 
    tm.table_label,
    tm.table_description,
    fm.field_name,
    fm.field_label,
    fm.field_type,
    fm.is_required,
    fm.is_display,
    fm.display_order
FROM sys_table_metadata tm
JOIN sys_field_metadata fm ON tm.table_name = fm.table_name
WHERE tm.table_name = 'sys_user'
ORDER BY fm.display_order;
```

### 2. è·å–æ¨¡å—ä¸‹çš„æ‰€æœ‰è¡¨
```sql
-- è·å–æ–‡æ¡£åˆ†ææ¨¡å—çš„æ‰€æœ‰è¡¨
SELECT table_name, table_label, table_description
FROM sys_table_metadata
WHERE module_name = 'æ–‡æ¡£åˆ†æ'
ORDER BY table_name;
```

### 3. è·å–ç‰¹å®šç±»å‹çš„è¡¨
```sql
-- è·å–æ‰€æœ‰ä¸šåŠ¡è¡¨
SELECT table_name, table_label, module_name
FROM sys_table_metadata
WHERE table_type = 'business' AND is_system = 0
ORDER BY table_name;
```

### 4. è·å–å¿…å¡«å­—æ®µ
```sql
-- è·å–ç”¨æˆ·è¡¨çš„å¿…å¡«å­—æ®µ
SELECT field_name, field_label, field_type, input_type
FROM sys_field_metadata
WHERE table_name = 'sys_user' AND is_required = 1
ORDER BY display_order;
```

### 5. è·å–å¯æœç´¢å­—æ®µ
```sql
-- è·å–æ‰€æœ‰å¯æœç´¢çš„å­—æ®µï¼Œç”¨äºæ„å»ºæœç´¢åŠŸèƒ½
SELECT 
    tm.table_name,
    tm.table_label,
    fm.field_name,
    fm.field_label,
    fm.field_type,
    fm.input_type
FROM sys_table_metadata tm
JOIN sys_field_metadata fm ON tm.table_name = fm.table_name
WHERE fm.is_searchable = 1 AND tm.is_system = 0
ORDER BY tm.table_name, fm.display_order;
```

## ğŸ”§ ç»´æŠ¤æ“ä½œ

### 1. æ·»åŠ æ–°è¡¨å­—æ®µ
```sql
-- æ·»åŠ æ–°å­—æ®µçš„å…ƒæ•°æ®
INSERT INTO sys_field_metadata (
    field_id, table_name, field_name, field_type, field_length,
    field_label, field_description, is_required, is_display,
    display_order, input_type
) VALUES (
    'fld_new', 'your_table', 'new_field', 'string', 50,
    'æ–°å­—æ®µ', 'æ–°å­—æ®µæè¿°', 1, 1, 11, 'text'
);
```

### 2. æ›´æ–°å­—æ®µå±æ€§
```sql
-- æ›´æ–°å­—æ®µçš„æ˜¾ç¤ºçŠ¶æ€
UPDATE sys_field_metadata
SET is_display = 0, display_order = 0
WHERE table_name = 'sys_user' AND field_name = 'password';
```

### 3. æ‰¹é‡æ›´æ–°å­—æ®µé¡ºåº
```sql
-- æ‰¹é‡è°ƒæ•´å­—æ®µæ˜¾ç¤ºé¡ºåº
UPDATE sys_field_metadata 
SET display_order = CASE field_name
    WHEN 'username' THEN 1
    WHEN 'email' THEN 2
    WHEN 'role' THEN 3
    ELSE display_order
END
WHERE table_name = 'sys_user';
```

## ğŸ¯ åœ¨æ–°ç³»ç»Ÿä¸­çš„æœ€ä½³å®è·µ

### 1. ä¸DocumentSystemé›†æˆ
```python
class MetadataManager:
    """å…ƒæ•°æ®ç®¡ç†å™¨ï¼Œé›†æˆåˆ°DocumentSystemä¸­"""
    
    def __init__(self, document_system):
        self.system = document_system
    
    def get_form_config(self, table_name):
        """è·å–è¡¨å•é…ç½®"""
        return generate_form_config(self.system, table_name)
    
    def get_api_docs(self, table_name):
        """è·å–APIæ–‡æ¡£"""
        return generate_api_docs(self.system, table_name)
    
    def get_validation_rules(self, table_name):
        """è·å–éªŒè¯è§„åˆ™"""
        metadata = get_table_metadata(self.system, table_name)
        if not metadata:
            return {}
        
        rules = {}
        for field in metadata['fields']:
            if field.get('validation'):
                rules[field['name']] = field['validation']
        
        return rules

# åœ¨DocumentSystemä¸­æ·»åŠ å…ƒæ•°æ®ç®¡ç†
class EnhancedDocumentSystem(DocumentSystem):
    """å¢å¼ºçš„æ–‡æ¡£ç³»ç»Ÿï¼ŒåŒ…å«å…ƒæ•°æ®ç®¡ç†"""
    
    def __init__(self, db_config=None):
        super().__init__(db_config)
        self.metadata_manager = MetadataManager(self)
    
    def get_form_config(self, table_name):
        """è·å–è¡¨å•é…ç½®"""
        return self.metadata_manager.get_form_config(table_name)
    
    def get_api_docs(self, table_name):
        """è·å–APIæ–‡æ¡£"""
        return self.metadata_manager.get_api_docs(table_name)
```

### 2. ç¼“å­˜ä¼˜åŒ–
```python
import functools
from datetime import datetime, timedelta

class CachedMetadataManager(MetadataManager):
    """å¸¦ç¼“å­˜çš„å…ƒæ•°æ®ç®¡ç†å™¨"""
    
    def __init__(self, document_system):
        super().__init__(document_system)
        self._cache = {}
        self._cache_timeout = timedelta(hours=1)  # ç¼“å­˜1å°æ—¶
    
    @functools.lru_cache(maxsize=128)
    def get_cached_metadata(self, table_name):
        """è·å–ç¼“å­˜çš„å…ƒæ•°æ®"""
        return get_table_metadata(self.system, table_name)
    
    def get_form_config(self, table_name):
        """è·å–è¡¨å•é…ç½®ï¼ˆå¸¦ç¼“å­˜ï¼‰"""
        cache_key = f"form_config_{table_name}"
        
        # æ£€æŸ¥ç¼“å­˜
        if cache_key in self._cache:
            cached_data, timestamp = self._cache[cache_key]
            if datetime.now() - timestamp < self._cache_timeout:
                return cached_data
        
        # ç”Ÿæˆæ–°çš„é…ç½®
        config = super().get_form_config(table_name)
        
        # å­˜å…¥ç¼“å­˜
        self._cache[cache_key] = (config, datetime.now())
        
        return config
```

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½è€ƒè™‘**: å…ƒæ•°æ®æŸ¥è¯¢ç›¸å¯¹é¢‘ç¹ï¼Œå»ºè®®å¢åŠ é€‚å½“ç¼“å­˜
2. **æ•°æ®ä¸€è‡´æ€§**: ç¡®ä¿å­—æ®µå…ƒæ•°æ®ä¸å®é™…è¡¨ç»“æ„ä¿æŒåŒæ­¥
3. **å®‰å…¨æ€§**: å…ƒæ•°æ®ä¸»è¦ç”¨äºå±•ç¤ºå’ŒéªŒè¯ï¼Œæ ¸å¿ƒä¸šåŠ¡é€»è¾‘ä»éœ€åœ¨ä»£ç ä¸­å®ç°
4. **ç‰ˆæœ¬æ§åˆ¶**: å½“è¡¨ç»“æ„å˜æ›´æ—¶ï¼ŒåŠæ—¶æ›´æ–°å…ƒæ•°æ®
5. **å‰ç«¯é›†æˆ**: validation_ruleä¸­çš„JSONæ ¼å¼éœ€è¦å‰ç«¯é…åˆå®ç°éªŒè¯é€»è¾‘

## ğŸ”— ä¸ç°æœ‰æ¨¡å—çš„é›†æˆ

### 1. ä¸ç”¨æˆ·æ¨¡å—é›†æˆ
```python
# åœ¨ç”¨æˆ·æ³¨å†Œæ—¶ä½¿ç”¨å…ƒæ•°æ®éªŒè¯
def validate_user_input(system, user_data):
    """ä½¿ç”¨å…ƒæ•°æ®éªŒè¯ç”¨æˆ·è¾“å…¥"""
    rules = get_table_metadata(system, 'sys_user')
    
    for field in rules['fields']:
        field_name = field['name']
        if field_name in user_data:
            validation = field.get('validation', {})
            
            # åº”ç”¨éªŒè¯è§„åˆ™
            if 'min_length' in validation:
                if len(user_data[field_name]) < validation['min_length']:
                    return False, f"{field['label']}é•¿åº¦ä¸è¶³"
            
            if 'pattern' in validation:
                import re
                if not re.match(validation['pattern'], user_data[field_name]):
                    return False, f"{field['label']}æ ¼å¼ä¸æ­£ç¡®"
    
    return True, "éªŒè¯é€šè¿‡"
```

### 2. ä¸æ–‡æ¡£æ¨¡å—é›†æˆ
```python
# åŠ¨æ€ç”Ÿæˆæ–‡æ¡£æœç´¢å­—æ®µ
def get_document_search_fields(system):
    """è·å–æ–‡æ¡£å¯æœç´¢å­—æ®µ"""
    query = """
    SELECT field_name, field_label, field_type
    FROM sys_field_metadata 
    WHERE table_name = 'doc_document' AND is_searchable = 1
    ORDER BY display_order
    """
    
    try:
        with system.db.get_connection() as conn:
            with conn.cursor(dictionary=True) as cursor:
                cursor.execute(query)
                return cursor.fetchall()
    except Exception as e:
        print(f"è·å–æœç´¢å­—æ®µå¤±è´¥: {e}")
        return []
```

é€šè¿‡åˆç†ä½¿ç”¨å­—æ®µè¡¨ï¼Œå¯ä»¥å¤§å¤§æé«˜ç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ï¼Œç‰¹åˆ«æ˜¯åœ¨åŠ¨æ€è¡¨å•ç”Ÿæˆã€APIæ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆå’Œæ•°æ®éªŒè¯æ–¹é¢å‘æŒ¥é‡è¦ä½œç”¨ã€‚
