# æ–‡æ¡£æ™ºèƒ½åˆ†æç³»ç»Ÿ - æ•°æ®åº“å…³ç³»æ¨¡å¼

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†æ–‡æ¡£æ™ºèƒ½åˆ†æç³»ç»Ÿçš„å®Œæ•´æ•°æ®åº“å…³ç³»æ¨¡å¼ã€‚æ•°æ®åº“è®¾è®¡æ”¯æŒç³»ç»Ÿçš„æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½ï¼ŒåŒ…æ‹¬ç”¨æˆ·ç®¡ç†ã€æ–‡æ¡£ç®¡ç†ã€å†…å®¹åˆ†æã€æ ‡ç­¾ç³»ç»Ÿã€å®ä½“è¯†åˆ«å’Œå¯¼å‡ºåŠŸèƒ½ã€‚åœ¨æ–°çš„ç³»ç»Ÿå°è£…ä¸­ï¼Œè¿™äº›è¡¨é€šè¿‡ç»Ÿä¸€çš„DocumentSystemç±»è¿›è¡Œè®¿é—®å’Œç®¡ç†ã€‚

## 1. å®ä½“å…³ç³»å›¾ï¼ˆERå›¾ï¼‰

### 1.1 æ ‡å‡†Mermaid ERå›¾

```mermaid
erDiagram
    sys_user {
        string user_id PK
        string username
        string email
        string password
        string role
        int status
        string theme
        string summary_length
        datetime create_time
        datetime update_time
    }
    
    doc_document {
        string doc_id PK
        string user_id FK
        string title
        string author
        datetime upload_date
        string file_path
        int file_size
        string file_format
        string category
        int is_deleted
    }
    
    doc_summary {
        string summary_id PK
        string doc_id FK
        string content
        string length_type
        datetime generate_time
    }
    
    doc_tag {
        string tag_id PK
        string doc_id FK
        string keyword
        string synonyms
        datetime generate_time
    }
    
    doc_entity {
        string entity_id PK
        string doc_id FK
        string name
        string type
        datetime recognize_time
    }
    
    doc_media {
        string media_id PK
        string doc_id FK
        string media_type
        string file_name
        string file_path
        int file_size
        int page_number
        string position_info
        datetime extract_time
        string description
    }
    
    doc_ocr_result {
        string ocr_id PK
        string doc_id FK
        int page_number
        string raw_text
        float confidence_score
        string language
        datetime process_time
        string bbox_data
    }
    
    entity_relation {
        string relation_id PK
        string source_entity_id FK
        string target_entity_id FK
        string relation_type
        float confidence_score
        string source_doc_id FK
        string evidence_text
        datetime create_time
        int is_manual
    }
    
    sys_operation_log {
        string log_id PK
        string user_id FK
        string doc_id FK
        string operation_type
        string operation_result
        datetime operation_time
        string device_info
        string error_msg
    }
    
    doc_export {
        string export_id PK
        string user_id FK
        string export_type
        string format
        string doc_ids
        string file_path
        int file_size
        string export_params
        string status
        datetime create_time
        datetime complete_time
        string error_msg
        int download_count
    }

    %% å…³ç³»å®šä¹‰
    sys_user ||--o{ doc_document : "æ‹¥æœ‰"
    sys_user ||--o{ sys_operation_log : "æ“ä½œ"
    sys_user ||--o{ doc_export : "å¯¼å‡º"
    
    doc_document ||--|| doc_summary : "ç”Ÿæˆ"
    doc_document ||--o{ doc_tag : "æ ‡è®°"
    doc_document ||--o{ doc_entity : "åŒ…å«"
    doc_document ||--o{ doc_media : "æå–"
    doc_document ||--o{ doc_ocr_result : "è¯†åˆ«"
    doc_document ||--o{ sys_operation_log : "æ¶‰åŠ"
    
    doc_entity ||--o{ entity_relation : "æºå®ä½“"
    doc_entity ||--o{ entity_relation : "ç›®æ ‡å®ä½“"
    doc_document ||--o{ entity_relation : "æ¥æºæ–‡æ¡£"
```

### 1.2 ç®€åŒ–çš„å…³ç³»å›¾ï¼ˆæ›´å…¼å®¹çš„ç‰ˆæœ¬ï¼‰

```mermaid
graph TD
    A[sys_user<br/>ç”¨æˆ·è¡¨] --> B[doc_document<br/>æ–‡æ¡£è¡¨]
    A --> C[sys_operation_log<br/>æ“ä½œæ—¥å¿—è¡¨]
    A --> D[doc_export<br/>å¯¼å‡ºè¡¨]
    
    B --> E[doc_summary<br/>æ‘˜è¦è¡¨]
    B --> F[doc_tag<br/>æ ‡ç­¾è¡¨]
    B --> G[doc_entity<br/>å®ä½“è¡¨]
    B --> H[doc_media<br/>åª’ä½“èµ„æºè¡¨]
    B --> I[doc_ocr_result<br/>OCRç»“æœè¡¨]
    B --> C
    
    G --> J[entity_relation<br/>å®ä½“å…³ç³»è¡¨]
    G --> J
    B --> J
    
    style A fill:#e1f5fe
    style B fill:#f3e5f5
    style C fill:#fff3e0
    style D fill:#e8f5e8
    style E fill:#fce4ec
    style F fill:#fff8e1
    style G fill:#e0f2f1
    style H fill:#f1f8e9
    style I fill:#ede7f6
    style J fill:#ffebee
```

### 1.3 ASCIIå…³ç³»å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   sys_user      â”‚
â”‚   (ç”¨æˆ·è¡¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚ æ‹¥æœ‰
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  doc_document   â”‚â”€â”€â”€â”€â–¶â”‚   doc_summary   â”‚     â”‚    doc_tag      â”‚
â”‚   (æ–‡æ¡£è¡¨)      â”‚     â”‚   (æ‘˜è¦è¡¨)      â”‚     â”‚   (æ ‡ç­¾è¡¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                   â”‚ æ‹¥æœ‰                 â”‚ æ ‡è®°
          â”‚ ç”Ÿæˆ              â–¼                      â–¼
          â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚           â”‚  doc_entity     â”‚     â”‚   doc_media     â”‚
          â”‚           â”‚   (å®ä½“è¡¨)      â”‚     â”‚  (åª’ä½“èµ„æºè¡¨)   â”‚
          â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                     â”‚ åŒ…å«
          â”‚                     â–¼
          â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚           â”‚ entity_relation  â”‚
          â”‚           â”‚  (å®ä½“å…³ç³»è¡¨)   â”‚
          â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”œâ”€â–¶ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   â”‚doc_ocr_result   â”‚
          â”‚   â”‚ (OCRç»“æœè¡¨)     â”‚
          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â”œâ”€â–¶ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚   â”‚sys_operation_logâ”‚
          â”‚   â”‚  (æ“ä½œæ—¥å¿—è¡¨)   â”‚
          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    doc_export   â”‚
â”‚   (å¯¼å‡ºè¡¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. è¡¨å…³ç³»è¯¦ç»†è¯´æ˜

### 2.1 æ ¸å¿ƒå®ä½“å…³ç³»

#### ç”¨æˆ·ä¸æ–‡æ¡£å…³ç³»ï¼ˆä¸€å¯¹å¤šï¼‰
```
sys_user (1) â†â†’ (N) doc_document
- ä¸€ä¸ªç”¨æˆ·å¯ä»¥ä¸Šä¼ å¤šä¸ªæ–‡æ¡£
- æ¯ä¸ªæ–‡æ¡£åªå±äºä¸€ä¸ªç”¨æˆ·
- å¤–é”®ï¼šdoc_document.user_id â†’ sys_user.user_id
```

**åœ¨æ–°ç³»ç»Ÿä¸­çš„å®ç°**ï¼š
```python
# åœ¨DocumentSystemä¸­
def list_user_documents(self, user_id, **kwargs):
    """åˆ—å‡ºç”¨æˆ·çš„æ‰€æœ‰æ–‡æ¡£"""
    return self.document_service.list_user_documents(user_id, **kwargs)
```

#### æ–‡æ¡£ä¸å†…å®¹å…³ç³»ï¼ˆä¸€å¯¹å¤šï¼‰
```
doc_document (1) â†â†’ (1) doc_summary
- æ¯ä¸ªæ–‡æ¡£åªæœ‰ä¸€ä¸ªæ‘˜è¦
- å¤–é”®ï¼šdoc_summary.doc_id â†’ doc_document.doc_id

doc_document (1) â†â†’ (N) doc_tag
- ä¸€ä¸ªæ–‡æ¡£å¯ä»¥æœ‰å¤šä¸ªæ ‡ç­¾
- å¤–é”®ï¼šdoc_tag.doc_id â†’ doc_document.doc_id

doc_document (1) â†â†’ (N) doc_entity
- ä¸€ä¸ªæ–‡æ¡£å¯ä»¥åŒ…å«å¤šä¸ªå®ä½“
- å¤–é”®ï¼šdoc_entity.doc_id â†’ doc_document.doc_id
```

**åœ¨æ–°ç³»ç»Ÿä¸­çš„å®ç°**ï¼š
```python
# è·å–æ–‡æ¡£çš„å®Œæ•´ä¿¡æ¯ï¼ˆåŒ…æ‹¬æ‘˜è¦ã€æ ‡ç­¾ã€å®ä½“ï¼‰
def get_document_info(self, doc_id):
    """è·å–æ–‡æ¡£å®Œæ•´ä¿¡æ¯"""
    return self.document_service.get_document_info(doc_id)
```

### 2.2 æ‰©å±•åŠŸèƒ½å…³ç³»

#### æ–‡æ¡£ä¸åª’ä½“èµ„æºå…³ç³»ï¼ˆä¸€å¯¹å¤šï¼‰
```
doc_document (1) â†â†’ (N) doc_media
- ä¸€ä¸ªæ–‡æ¡£å¯ä»¥æå–å¤šä¸ªå›¾ç‰‡/è¡¨æ ¼
- å¤–é”®ï¼šdoc_media.doc_id â†’ doc_document.doc_id
```

#### æ–‡æ¡£ä¸OCRç»“æœå…³ç³»ï¼ˆä¸€å¯¹å¤šï¼‰
```
doc_document (1) â†â†’ (N) doc_ocr_result
- ä¸€ä¸ªæ–‡æ¡£æ¯é¡µéƒ½æœ‰ä¸€ä¸ªOCRç»“æœ
- å¤–é”®ï¼šdoc_ocr_result.doc_id â†’ doc_document.doc_id
```

### 2.3 å®ä½“å…³ç³»ç½‘ç»œ

#### å®ä½“é—´å…³ç³»ï¼ˆå¤šå¯¹å¤šï¼‰
```
doc_entity (1) â†â†’ (N) entity_relation â†â†’ (1) doc_entity
- æ”¯æŒå®ä½“é—´çš„åŒå‘å…³ç³»
- å¤–é”®ï¼šentity_relation.source_entity_id â†’ doc_entity.entity_id
- å¤–é”®ï¼šentity_relation.target_entity_id â†’ doc_entity.entity_id
```

**åœ¨æ–°ç³»ç»Ÿä¸­çš„å®ç°**ï¼š
```python
# è·å–æ–‡æ¡£å®ä½“
def get_document_entities(self, doc_id):
    """è·å–æ–‡æ¡£å®ä½“"""
    return self.entity_model.get_entities_by_doc_id(doc_id)
```

### 2.4 æ“ä½œä¸æ—¥å¿—å…³ç³»

#### ç”¨æˆ·æ“ä½œæ—¥å¿—ï¼ˆä¸€å¯¹å¤šï¼‰
```
sys_user (1) â†â†’ (N) sys_operation_log
- è®°å½•ç”¨æˆ·çš„æ‰€æœ‰æ“ä½œ
- å¤–é”®ï¼šsys_operation_log.user_id â†’ sys_user.user_id

doc_document (1) â†â†’ (N) sys_operation_log
- è®°å½•æ–‡æ¡£ç›¸å…³æ“ä½œ
- å¤–é”®ï¼šsys_operation_log.doc_id â†’ doc_document.doc_id
```

#### ç”¨æˆ·å¯¼å‡ºç®¡ç†ï¼ˆä¸€å¯¹å¤šï¼‰
```
sys_user (1) â†â†’ (N) doc_export
- ç®¡ç†ç”¨æˆ·çš„æ‰€æœ‰å¯¼å‡ºä»»åŠ¡
- å¤–é”®ï¼šdoc_export.user_id â†’ sys_user.user_id
```

## 3. å…³ç³»ç±»å‹æ€»ç»“

### 3.1 ä¸€å¯¹ä¸€å…³ç³» (1:1)
- doc_document â†” doc_summaryï¼šæ¯ä¸ªæ–‡æ¡£å¯¹åº”ä¸€ä¸ªæ‘˜è¦

### 3.2 ä¸€å¯¹å¤šå…³ç³» (1:N)
- sys_user â†’ doc_documentï¼šç”¨æˆ·æ‹¥æœ‰æ–‡æ¡£
- sys_user â†’ sys_operation_logï¼šç”¨æˆ·æ“ä½œæ—¥å¿—
- sys_user â†’ doc_exportï¼šç”¨æˆ·å¯¼å‡ºè®°å½•
- doc_document â†’ doc_tagï¼šæ–‡æ¡£æ ‡ç­¾
- doc_document â†’ doc_entityï¼šæ–‡æ¡£å®ä½“
- doc_document â†’ doc_mediaï¼šæ–‡æ¡£åª’ä½“èµ„æº
- doc_document â†’ doc_ocr_resultï¼šæ–‡æ¡£OCRç»“æœ
- doc_document â†’ sys_operation_logï¼šæ–‡æ¡£æ“ä½œæ—¥å¿—

### 3.3 å¤šå¯¹å¤šå…³ç³» (M:N)
- doc_entity â†” doc_entityï¼ˆé€šè¿‡entity_relationè¡¨ï¼‰ï¼šå®ä½“å…³ç³»ç½‘ç»œ

## 4. åœ¨æ–°ç³»ç»Ÿä¸­çš„æ•°æ®æµå‘åˆ†æ

### 4.1 ä¸»è¦æ•°æ®æµå‘
```
ç”¨æˆ· â†’ æ–‡æ¡£ä¸Šä¼  â†’ å†…å®¹æå– â†’ åˆ†æå¤„ç† â†’ ç»“æœå­˜å‚¨
```

### 4.2 è¯¦ç»†æµç¨‹ä¸æ–°ç³»ç»Ÿé›†æˆ

#### 1. ç”¨æˆ·ç®¡ç†æµç¨‹
```python
# ç”¨æˆ·æ³¨å†Œ
system.register_user(username, email, password, **kwargs)
# â†’ sys_userè¡¨æ’å…¥æ•°æ®

# ç”¨æˆ·ç™»å½•
system.login_user(username, password)
# â†’ sys_userè¡¨éªŒè¯ + sys_operation_logè®°å½•

# ç”¨æˆ·èµ„æ–™ç®¡ç†
system.get_user_profile(user_id)
system.update_user_profile(user_id, **kwargs)
# â†’ sys_userè¡¨æ“ä½œ
```

#### 2. æ–‡æ¡£ç®¡ç†æµç¨‹
```python
# æ–‡æ¡£ä¸Šä¼ 
system.upload_document(user_id, title, author, file_path, **kwargs)
# â†’ doc_documentè¡¨æ’å…¥ + sys_operation_logè®°å½•

# æ–‡æ¡£ä¿¡æ¯è·å–
system.get_document_info(doc_id)
# â†’ è”åˆæŸ¥è¯¢ doc_document + doc_summary + doc_tag + doc_entity

# æ–‡æ¡£æœç´¢
system.search_documents(**kwargs)
# â†’ doc_documentè¡¨æœç´¢ + æ ‡ç­¾å…³è”æœç´¢
```

#### 3. æ ‡ç­¾ç®¡ç†æµç¨‹
```python
# åˆ›å»ºæ ‡ç­¾
system.create_tag(doc_id, keyword, synonyms=None)
# â†’ doc_tagè¡¨æ’å…¥

# æ ‡ç­¾æœç´¢
system.search_documents_by_keywords(keywords, match_type='any', limit=50)
# â†’ doc_tagè¡¨ + doc_documentè¡¨è”åˆæŸ¥è¯¢

# çƒ­é—¨æ ‡ç­¾
system.get_popular_keywords(limit=20)
# â†’ doc_tagè¡¨èšåˆæŸ¥è¯¢
```

#### 4. ç»Ÿè®¡ä¿¡æ¯æµç¨‹
```python
# ç”¨æˆ·ç»Ÿè®¡
system.get_user_stats()
# â†’ sys_userè¡¨ + doc_documentè¡¨èšåˆæŸ¥è¯¢

# æ–‡æ¡£ç»Ÿè®¡
system.get_document_stats(user_id=None)
# â†’ doc_documentè¡¨èšåˆæŸ¥è¯¢

# æ ‡ç­¾ç»Ÿè®¡
system.get_tag_stats()
# â†’ doc_tagè¡¨èšåˆæŸ¥è¯¢
```

## 5. çº¦æŸå’Œç´¢å¼•ä¼˜åŒ–

### 5.1 å¤–é”®çº¦æŸ
- æ‰€æœ‰å¤–é”®éƒ½è®¾ç½®äº†çº§è”åˆ é™¤æˆ–ç©ºå€¼å¤„ç†
- ä¿è¯æ•°æ®å¼•ç”¨å®Œæ•´æ€§

### 5.2 ç´¢å¼•ä¼˜åŒ–ç­–ç•¥

#### ä¸»è¦ç´¢å¼•
```sql
-- ç”¨æˆ·ç›¸å…³ç´¢å¼•
CREATE INDEX idx_user_username ON sys_user(username);
CREATE INDEX idx_user_email ON sys_user(email);
CREATE INDEX idx_user_status ON sys_user(status);

-- æ–‡æ¡£ç›¸å…³ç´¢å¼•
CREATE INDEX idx_doc_user ON doc_document(user_id);
CREATE INDEX idx_doc_title ON doc_document(title);
CREATE INDEX idx_doc_author ON doc_document(author);
CREATE INDEX idx_doc_category ON doc_document(category);
CREATE INDEX idx_doc_upload_date ON doc_document(upload_date);
CREATE INDEX idx_doc_deleted ON doc_document(is_deleted);

-- æ ‡ç­¾ç›¸å…³ç´¢å¼•
CREATE INDEX idx_tag_doc ON doc_tag(doc_id);
CREATE INDEX idx_tag_keyword ON doc_tag(keyword);
CREATE INDEX idx_tag_generate_time ON doc_tag(generate_time);

-- å®ä½“ç›¸å…³ç´¢å¼•
CREATE INDEX idx_entity_doc ON doc_entity(doc_id);
CREATE INDEX idx_entity_name ON doc_entity(name);
CREATE INDEX idx_entity_type ON doc_entity(type);
CREATE INDEX idx_entity_recognize_time ON doc_entity(recognize_time);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_doc_user_category ON doc_document(user_id, category);
CREATE INDEX idx_tag_keyword_doc ON doc_tag(keyword, doc_id);
```

#### æ–°ç³»ç»Ÿä¸­çš„æŸ¥è¯¢ä¼˜åŒ–
```python
# åœ¨DocumentSystemä¸­ï¼ŒæŸ¥è¯¢å·²ç»è¿‡ä¼˜åŒ–
def search_documents(self, **kwargs):
    """æœç´¢æ–‡æ¡£ - å·²ä¼˜åŒ–çš„æŸ¥è¯¢"""
    return self.document_service.search_documents(**kwargs)

def search_documents_by_keywords(self, keywords, match_type='any', limit=50):
    """å…³é”®è¯æœç´¢ - ä½¿ç”¨ç´¢å¼•ä¼˜åŒ–"""
    return self.tag_model.search_documents_by_keywords(keywords, match_type, limit)
```

## 6. æ‰©å±•æ€§è®¾è®¡

### 6.1 æ°´å¹³æ‰©å±•
- æ”¯æŒæŒ‰ç”¨æˆ·åˆ†åº“åˆ†è¡¨
- æ”¯æŒæ–‡æ¡£å­˜å‚¨çš„åˆ†å¸ƒå¼æ¶æ„

### 6.2 å‚ç›´æ‰©å±•
- å®ä½“å…³ç³»è¡¨æ”¯æŒå¤æ‚çš„å›¾è°±æ‰©å±•
- å¯¼å‡ºè¡¨æ”¯æŒå¤šç§æ ¼å¼çš„åŠ¨æ€æ‰©å±•

### 6.3 æ–°ç³»ç»Ÿä¸­çš„æ‰©å±•æ€§
```python
# DocumentSystemæ”¯æŒé…ç½®åŒ–æ‰©å±•
system = create_document_system(db_config)

# å¯ä»¥è½»æ¾æ·»åŠ æ–°çš„åŠŸèƒ½æ¨¡å—
class EnhancedDocumentSystem(DocumentSystem):
    def __init__(self, db_config=None):
        super().__init__(db_config)
        # æ·»åŠ æ–°çš„æœåŠ¡æˆ–æ¨¡å‹
        self.new_service = NewService()
    
    def new_functionality(self, **kwargs):
        """æ–°å¢åŠŸèƒ½"""
        return self.new_service.do_something(**kwargs)
```

## 7. æ•°æ®å®Œæ•´æ€§ä¿è¯

### 7.1 äº‹åŠ¡å¤„ç†
åœ¨æ–°ç³»ç»Ÿä¸­ï¼Œæ‰€æœ‰å…³é”®æ“ä½œéƒ½ä½¿ç”¨äº‹åŠ¡ä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼š

```python
# ç¤ºä¾‹ï¼šæ–‡æ¡£ä¸Šä¼ äº‹åŠ¡
def upload_document_with_transaction(self, user_id, title, author, file_path, **kwargs):
    """å¸¦äº‹åŠ¡çš„æ–‡æ¡£ä¸Šä¼ """
    try:
        with self.db.get_connection() as conn:
            with conn.cursor() as cursor:
                # å¼€å§‹äº‹åŠ¡
                conn.begin()
                
                # 1. æ’å…¥æ–‡æ¡£è®°å½•
                doc_id = self.document_model.create_document(...)
                
                # 2. è®°å½•æ“ä½œæ—¥å¿—
                self.log_operation(user_id, doc_id, 'upload', 'success')
                
                # æäº¤äº‹åŠ¡
                conn.commit()
                return doc_id
    except Exception as e:
        conn.rollback()
        raise e
```

### 7.2 æ•°æ®éªŒè¯
```python
# åœ¨DocumentSystemä¸­è¿›è¡Œæ•°æ®éªŒè¯
def register_user(self, username, email, password, **kwargs):
    """ç”¨æˆ·æ³¨å†Œ - åŒ…å«æ•°æ®éªŒè¯"""
    # 1. åŸºç¡€éªŒè¯
    if not username or not email or not password:
        return {'success': False, 'message': 'å¿…å¡«å­—æ®µä¸èƒ½ä¸ºç©º'}
    
    # 2. å”¯ä¸€æ€§éªŒè¯
    if self.user_model.get_user_by_username(username):
        return {'success': False, 'message': 'ç”¨æˆ·åå·²å­˜åœ¨'}
    
    # 3. å§”æ‰˜ç»™æœåŠ¡å±‚
    return self.user_service.register_user(username, email, password, **kwargs)
```

## 8. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 8.1 æŸ¥è¯¢ä¼˜åŒ–
- ä½¿ç”¨å¤åˆç´¢å¼•ä¼˜åŒ–å¸¸ç”¨æŸ¥è¯¢
- åˆ†é¡µæŸ¥è¯¢é¿å…å¤§ç»“æœé›†
- ä½¿ç”¨è¿æ¥æŸ¥è¯¢å‡å°‘æ•°æ®åº“å¾€è¿”

### 8.2 ç¼“å­˜ç­–ç•¥
- å…ƒæ•°æ®ç¼“å­˜ï¼ˆè¡¨ç»“æ„ã€å­—æ®µä¿¡æ¯ï¼‰
- ç”¨æˆ·ä¼šè¯ç¼“å­˜
- çƒ­é—¨æ•°æ®ç¼“å­˜

### 8.3 æ–°ç³»ç»Ÿä¸­çš„æ€§èƒ½ä¼˜åŒ–
```python
# åœ¨DocumentSystemä¸­å®ç°ç¼“å­˜
from functools import lru_cache

class OptimizedDocumentSystem(DocumentSystem):
    def __init__(self, db_config=None):
        super().__init__(db_config)
        self._cache = {}
    
    @lru_cache(maxsize=1000)
    def get_document_info_cached(self, doc_id):
        """å¸¦ç¼“å­˜çš„æ–‡æ¡£ä¿¡æ¯è·å–"""
        return self.get_document_info(doc_id)
    
    def clear_cache(self):
        """æ¸…é™¤ç¼“å­˜"""
        self.get_document_info_cached.cache_clear()
```

## 9. ç›‘æ§å’Œç»´æŠ¤

### 9.1 æ•°æ®åº“ç›‘æ§
- è¿æ¥æ•°ç›‘æ§
- æŸ¥è¯¢æ€§èƒ½ç›‘æ§
- æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æ

### 9.2 æ•°æ®ç»´æŠ¤
- å®šæœŸæ•°æ®å¤‡ä»½
- æ—¥å¿—æ¸…ç†ç­–ç•¥
- ç´¢å¼•é‡å»º

### 9.3 æ–°ç³»ç»Ÿä¸­çš„ç›‘æ§
```python
# åœ¨DocumentSystemä¸­æ·»åŠ ç›‘æ§åŠŸèƒ½
class MonitoredDocumentSystem(DocumentSystem):
    def __init__(self, db_config=None):
        super().__init__(db_config)
        self.query_count = 0
        self.error_count = 0
    
    def _execute_with_monitoring(self, query_func, *args, **kwargs):
        """å¸¦ç›‘æ§çš„æŸ¥è¯¢æ‰§è¡Œ"""
        try:
            self.query_count += 1
            result = query_func(*args, **kwargs)
            return result
        except Exception as e:
            self.error_count += 1
            raise e
    
    def get_stats(self):
        """è·å–ç³»ç»Ÿç»Ÿè®¡"""
        return {
            'query_count': self.query_count,
            'error_count': self.error_count,
            'success_rate': (self.query_count - self.error_count) / max(self.query_count, 1)
        }
```

---

## ğŸ“ æ€»ç»“

æ–°çš„æ•°æ®åº“å…³ç³»æ¨¡å¼å®Œå…¨æ”¯æŒæ–‡æ¡£æ™ºèƒ½åˆ†æç³»ç»Ÿçš„æ‰€æœ‰åŠŸèƒ½éœ€æ±‚ï¼Œé€šè¿‡DocumentSystemç±»çš„ç»Ÿä¸€å°è£…ï¼Œæä¾›äº†ï¼š

1. **å®Œæ•´çš„åŠŸèƒ½è¦†ç›–**ï¼šæ”¯æŒç”¨æˆ·ç®¡ç†ã€æ–‡æ¡£ç®¡ç†ã€å†…å®¹åˆ†æç­‰æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½
2. **ä¼˜åŒ–çš„æŸ¥è¯¢æ€§èƒ½**ï¼šé€šè¿‡åˆç†çš„ç´¢å¼•è®¾è®¡å’ŒæŸ¥è¯¢ä¼˜åŒ–
3. **æ•°æ®å®Œæ•´æ€§ä¿è¯**ï¼šé€šè¿‡äº‹åŠ¡å¤„ç†å’Œæ•°æ®éªŒè¯
4. **è‰¯å¥½çš„æ‰©å±•æ€§**ï¼šæ”¯æŒæ°´å¹³æ‰©å±•å’ŒåŠŸèƒ½æ‰©å±•
5. **ä¾¿äºç»´æŠ¤**ï¼šæ¸…æ™°çš„è¡¨ç»“æ„å’Œå®Œå–„çš„æ–‡æ¡£

è¯¥è®¾è®¡ä¸ºç³»ç»Ÿçš„é•¿æœŸç¨³å®šè¿è¡Œå’ŒåŠŸèƒ½æ‰©å±•æä¾›äº†åšå®çš„æ•°æ®åŸºç¡€ã€‚

---

*æœ€åæ›´æ–°: 2025å¹´12æœˆ*
